{# Requires Alpine component intersect in target: {% static 'js/alpine/components/intersect.js' %} #}
{% load svg_tags static component_tags %}
{% require_script "js/alpine/components/navigation_menu.js" %}

<c-vars nav_items ></c-vars>
{{ nav_items|json_script:"nav-items" }}

{# DESKTOP #}

<div x-data="navMenu" class="max-md:hidden overflow-y-auto h-[100vh] sticky top-5 min-w-[222px]">
<nav class="sticky top-0 flex flex-col flex-wrap items-start min-w-[222px]">
<ul class="list-disc list-inside">
  {% for item in nav_items %}
    <li
      data-intersect-target="{{ item.href }}"
      class="pl-3.5 w-full marker:text-greyscale-200"
      x-bind:class="markerClass"
    >
      <div class="-mt-7 ml-4 text-sm font-sans flex justify-start items-center gap-2 flex-wrap">
        <a
          x-bind:class="itemClass"
          href="{{ item.href }}"
          class="py-1.5 font-semibold"
          data-intersect-target="{{ item.href }}"
        >
          {{ item.text }}
        </a>
        <button
          x-show="hasChildren"
          x-on:click="toggleExpansion"
          data-intersect-target="{{ item.href }}"
        >
          <div
            x-bind:class="iconClass"
            data-intersect-target="{{ item.href }}"
            class="transition-transform duration-200 flex justify-center items-center w-4 h-4"
          >{% svg 'chevron' css_class="w-full h-full" %}
          </div>
        </button>
      </div>
      <ul
        x-show="isExpanded"
        x-collapse
        data-intersect-target="{{ item.href }}"
        class="flex flex-col"
      >
        {% for sub_item in item.children %}
          <a
            x-bind:class="childClass"
            href="{{ sub_item.href }}"
            class="w-full pl-7.5 py-1.5 font-normal text-sm"
            data-intersect-target="{{ sub_item.href }}"
          >{{ sub_item.text }}</a>
        {% endfor %}
      </ul>
    </li>
  {% endfor %}
</ul>
</nav>
</div>

{# MOBILE #}

<div x-data="navMenu" class="relative w-full md:hidden">
  <button
    x-on:click="toggleMenu"
    type="button"
    class="w-full flex flex-row justify-between border border-greyscale-200 bg-white py-3 px-3.5 rounded-[10px] text-sm font-medium text-greyscale-900 focus:ring-2 focus:ring-primary-400 focus:outline-none"
    aria-haspopup="listbox"
    x-bind:aria-expanded="menuOpen"
    aria-labelledby="listbox-label"
  >
    <span id="listbox-label" class="text-sm font-medium text-greyscale-600" x-text="visibleSectionText"></span>
    <img aria-hidden="true" src="{% static "svg/chevron.svg" %}">
  </button>
  <ul
    x-show="menuOpen"
    x-on:click.outside="closeMenu"
    x-on:keyup.esc="closeMenu"
    class="absolute z-10 mt-2 max-h-[320px] w-full overflow-auto rounded-lg bg-white py-1 shadow-lg border border-greyscale-200 focus:outline-hidden"
    tabindex="-1"
    role="listbox"
    aria-labelledby="listbox-label"
    aria-activedescendant="listbox-option-3"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-100"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
  >
    <template x-for="option in options" :key="option.href">
      <li class="relative cursor-default py-[1px] px-1.5 select-none" role="option">
        <a x-on:click="closeMenu" x-bind:href="option.href" class="py-2.5 px-2 hover:bg-greyscale-100 rounded-md flex flex-row justify-between">
          <span class="truncate font-medium text-sm text-greyscale-600" x-text="option.text"></span>
          <img x-bind:data-intersect-target="option.href" x-show="isVisible" class="" aria-hidden="true" src="{% static "svg/check.svg" %}">
        </a>
        <template
          x-if="hasChildren"
          x-bind:data-intersect-target="option.href"
        >
          <ul class="flex flex-col w-full">
            <template x-for="subItem in option.children">
              <a
                x-on:click="closeMenu"
                x-bind:href="subItem.href"
                class="w-full pl-7.5 py-1.5 font-normal text-sm text-greyscale-600"
                x-bind:data-intersect-target="subItem.href"
                x-text="subItem.text"
              ></a>
            </template>
          </ul>
        </template>
      </li>
    </template>
  </ul>
</div>
